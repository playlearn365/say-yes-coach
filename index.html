<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師家長溝通話術精煉工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f9;
        }
        @media (max-width: 640px) {
            #app-container {
                padding: 1rem;
            }
        }
        textarea::placeholder {
            color: #9ca3af;
            opacity: 1;
            font-style: italic;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div id="app-container" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-2xl border border-gray-100">

    <!-- 標題 -->
    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-pink-600 tracking-tight">
            幼兒園親師溝通 SAY YES 教練
        </h1>
        <p class="text-gray-500 mt-2 text-lg">
            請選擇情境，教練將依據您提供的資訊，協助潤飾訊息。
        </p>
    </header>
    
    <!-- 情境選擇器 -->
    <div class="mb-4">
        <label class="block text-lg font-medium text-gray-700 mb-2">
            請選擇您想處理的情境：
        </label>
        <div class="flex space-x-4 bg-gray-100 p-2 rounded-lg">
            <label class="flex-1">
                <input type="radio" name="format-selector" value="event" id="format-event" class="hidden peer" checked>
                <div class="text-center py-2 px-4 rounded-lg cursor-pointer transition duration-150 ease-in-out bg-white text-gray-700 font-semibold shadow-md peer-checked:bg-pink-500 peer-checked:text-white peer-checked:shadow-lg hover:bg-gray-200">
                    事件回覆 (Event)
                </div>
            </label>
            <label class="flex-1">
                <input type="radio" name="format-selector" value="affair" id="format-affair" class="hidden peer">
                <div class="text-center py-2 px-4 rounded-lg cursor-pointer transition duration-150 ease-in-out bg-white text-gray-700 font-semibold shadow-md peer-checked:bg-pink-500 peer-checked:text-white peer-checked:shadow-lg hover:bg-gray-200">
                    事務通知 (Affair)
                </div>
            </label>
        </div>
    </div>

    <!-- 老師輸入區（含固定提示框） -->
    <div class="mb-6">
        <label for="input-draft" class="block text-lg font-medium text-gray-700 mb-2">
            教練的結構化輸入資訊
        </label>

        <!-- 事件回覆提示 -->
        <div id="event-hint" class="mb-2 text-sm text-gray-500 italic bg-gray-50 border border-dashed border-gray-300 rounded-lg p-3">
            範例填寫方式（事件回覆）：<br>
            {事件性質}: 爭奪玩具推擠<br>
            {摘要}: 兩位幼兒在角落區爭搶同一個玩具，情緒激動，有互相推擠的情形。<br>
            {已採取措施}: 立即分開兩人，先安撫情緒，陪同說清楚彼此的想法與需求。<br>
            {家長配合}: 在家可陪孩子練習輪流、說清楚需求的句子。<br>
            {後續追蹤}: 老師會在角落區遊戲時多加觀察，適時提醒與引導。
        </div>

        <!-- 事務通知提示 -->
        <div id="affair-hint" class="mb-2 text-sm text-gray-500 italic bg-gray-50 border border-dashed border-gray-300 rounded-lg p-3 hidden">
            範例填寫方式（事務通知）：<br>
            {事務主題}: 親子運動會補充說明<br>
            {重要資訊}: 活動時間、集合地點、需自備物品等。<br>
            {需要家長配合/回覆的事項}: 是否出席、飲食或健康注意事項回條。
        </div>

        <textarea id="input-draft" rows="8"
                  class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-pink-500 focus:ring focus:ring-pink-200/50 transition duration-150 ease-in-out resize-none text-base"
                  placeholder="請用自己的方式輸入想跟家長說明的重點，可以照上方範例結構，也可以只寫一兩句關鍵描述。"></textarea>
    </div>

    <!-- 精煉按鈕 -->
    <button id="refine-button"
            class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed">
        <span id="button-text">轉換為專業溝通訊息</span>
        <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </button>

    <!-- 錯誤/提示訊息區 -->
    <div id="message-box" class="mt-4 p-3 hidden rounded-lg bg-red-100 text-red-700 border border-red-200"></div>

    <!-- 輸出區 -->
    <div class="mt-8">
        <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">
            潤飾後的家長訊息 (可直接複製使用)
        </h2>
        <div id="output-message" class="min-h-[250px] p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-800 whitespace-pre-wrap leading-relaxed transition-all duration-300">
            按下「轉換為專業溝通訊息」按鈕，教練將為您生成訊息。
        </div>
    </div>
</div>

<script>
    const inputDraft = document.getElementById('input-draft');
    const refineButton = document.getElementById('refine-button');
    const buttonText = document.getElementById('button-text');
    const loadingSpinner = document.getElementById('loading-spinner');
    const outputMessage = document.getElementById('output-message');
    const messageBox = document.getElementById('message-box');
    const formatEventRadio = document.getElementById('format-event');
    const formatAffairRadio = document.getElementById('format-affair');
    const eventHint = document.getElementById('event-hint');
    const affairHint = document.getElementById('affair-hint');

    // 切換上方提示框
    function updateHint(format) {
        if (format === 'event') {
            eventHint.classList.remove('hidden');
            affairHint.classList.add('hidden');
        } else {
            eventHint.classList.add('hidden');
            affairHint.classList.remove('hidden');
        }
    }

    function showMessage(text, isError = true) {
        messageBox.textContent = text;
        messageBox.className = isError
            ? "mt-4 p-3 rounded-lg bg-red-100 text-red-700 border border-red-200"
            : "mt-4 p-3 rounded-lg bg-green-100 text-green-700 border border-green-200";
        messageBox.style.display = 'block';
    }

    function clearMessage() {
        messageBox.style.display = 'none';
        messageBox.textContent = '';
    }

    // 解析老師輸入的結構化文字（如果有就用，沒有就當成自由輸入）
    function parseStructuredInput(draft, isEvent) {
        const lines = draft.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        const data = {
            事件性質: "",
            摘要: "",
            已採取措施: "",
            家長配合: "",
            後續追蹤: "",
            事務主題: "",
            重要資訊: "",
            家長行動: "",
            自由輸入: draft.trim()
        };

        lines.forEach(line => {
            const sepIndex = line.indexOf(':') !== -1 ? line.indexOf(':') : line.indexOf('：');
            if (sepIndex === -1) return;
            const rawKey = line.slice(0, sepIndex).replace(/[{}]/g, "").trim();
            const value = line.slice(sepIndex + 1).trim();

            if (rawKey.includes('事件性質')) data.事件性質 = value;
            else if (rawKey.includes('摘要')) data.摘要 = value;
            else if (rawKey.includes('已採取措施') || rawKey.includes('已采取措施')) data.已採取措施 = value;
            else if (rawKey.includes('家長配合')) data.家長配合 = value;
            else if (rawKey.includes('後續追蹤')) data.後續追蹤 = value;
            else if (rawKey.includes('事務主題')) data.事務主題 = value;
            else if (rawKey.includes('重要資訊')) data.重要資訊 = value;
            else if (rawKey.includes('需要家長配合') || rawKey.includes('回覆的事項')) data.家長行動 = value;
        });

        // 如果老師沒有照結構填，就把整段當成摘要或事務內容
        if (isEvent) {
            if (!data.事件性質) {
                const firstLine = lines[0] || draft;
                data.事件性質 = firstLine.slice(0, 15);
            }
            if (!data.摘要) {
                data.摘要 = draft.trim();
            }
        } else {
            if (!data.事務主題) {
                const firstLine = lines[0] || draft;
                data.事務主題 = firstLine.slice(0, 20);
            }
            if (!data.重要資訊) {
                data.重要資訊 = draft.trim();
            }
        }

        return data;
    }

    // 組合「事件回覆」訊息（本地模板）
    function buildEventMessage(data) {
        const e = (t) => t && t.length > 0 ? t : "（老師可依實際情況補充）";

        return `家長您好：

今天在園內發生一件關於「${e(data.事件性質)}」的小狀況，想先主動跟您說明，讓我們一起陪孩子練習面對人際互動。

【事件經過】
${e(data.摘要)}

【老師當下的處理】
${e(data.已採取措施)}

【在家可以一起配合的方向】
${e(data.家長配合)}

【後續在園的追蹤】
${e(data.後續追蹤)}

我們都很關心孩子在園內的安全與情緒，也希望透過這次的經驗，陪孩子學會更好的表達與合作方式。如果您有任何想法或擔心，都非常歡迎隨時與我分享，一起討論最適合孩子的做法。

謝謝您一直以來的支持與信任。`;
    }

    // 組合「事務通知」訊息（本地模板）
    function buildAffairMessage(data) {
        const e = (t) => t && t.length > 0 ? t : "（老師可依實際情況補充）";

        let infoBlock = e(data.重要資訊);
        if (!infoBlock.startsWith('1.') && infoBlock.includes('、')) {
            const parts = infoBlock.split(/、|\n/).map(p => p.trim()).filter(p => p.length > 0);
            if (parts.length > 1) {
                infoBlock = parts.map((p, i) => `${i + 1}. ${p}`).join('\n');
            }
        }

        return `家長您好：

關於${e(data.事務主題)}，想先和您說明相關安排如下，方便您事先了解與準備。

【重要資訊】
${infoBlock}

【請家長協助的部分】
${e(data.家長行動)}

若您在時間或安排上有任何困難，都可以再與我或園方聯繫，我們會一起想合適的調整方式。也謝謝您在忙碌之餘，仍願意與我們一同配合與支持。

再次感謝您的理解與協助。`;
    }

    async function refineMessage() {
        clearMessage();
        const draft = inputDraft.value.trim();
        const isEvent = formatEventRadio.checked;

        // 只要有打一點點就可以，不再要求完整格式
        if (draft.length < 2) {
            showMessage("請先在上方輸入想跟家長說明的內容，可以只寫一兩句。", true);
            return;
        }

        refineButton.disabled = true;
        buttonText.textContent = "教練思考中...";
        loadingSpinner.classList.remove('hidden');
        outputMessage.textContent = '教練正在依據您提供的重點，整理合適的家長訊息...';
        outputMessage.classList.add('animate-pulse');

        try {
            const data = parseStructuredInput(draft, isEvent);
            const resultText = isEvent ? buildEventMessage(data) : buildAffairMessage(data);
            outputMessage.textContent = resultText;
        } catch (error) {
            console.error(error);
            showMessage("轉換過程中發生小問題，請稍後再試或檢查輸入格式。", true);
            outputMessage.textContent = '轉換失敗，請重新整理頁面或稍後再試。';
        } finally {
            refineButton.disabled = false;
            buttonText.textContent = "轉換為專業溝通訊息";
            loadingSpinner.classList.add('hidden');
            outputMessage.classList.remove('animate-pulse');
        }
    }

    refineButton.addEventListener('click', refineMessage);
    formatEventRadio.addEventListener('change', () => updateHint('event'));
    formatAffairRadio.addEventListener('change', () => updateHint('affair'));

    window.onload = () => {
        updateHint('event');
        outputMessage.textContent = '按下「轉換為專業溝通訊息」按鈕，教練將為您生成訊息。';
    };
</script>

</body>
</html>
